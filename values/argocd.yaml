# https://artifacthub.io/packages/helm/argo/argo-cd
configs:
  secret:
    argocdServerAdminPassword: $2a$10$7BuGb2czbMSz/Oyd0A56Deqf6xzGFuBqLJDhzP/z4wVMaakYXnQaC%
  params:
    server.insecure: true
  repositories:
    main:
      url: https://github.com/dr-kube/dr-kube.git
      name: dr-kube
      type: git
  cm:
    # CRD metadata.annotations can exceed 262144 bytes (e.g. applicationsets.argoproj.io); ignore to avoid sync failure
    resource.customizations.ignoreResourceUpdates.apiextensions.k8s.io_CustomResourceDefinition: |
      jqPathExpressions:
        - '.metadata.annotations'

controller:
  resources:
    requests:
      cpu: 500m
      memory: 600Mi
    limits:
      cpu: 750m
      memory: 1000Mi

applicationSet:
  resources:
    requests:
      cpu: 50m
      memory: 70Mi
    limits:
      cpu: 100m
      memory: 140Mi

dex:
  resources:
    requests:
      cpu: 50m
      memory: 100Mi
    limits:
      cpu: 100m
      memory: 120Mi

redis:
  resources:
    requests:
      cpu: 20m
      memory: 50Mi
    limits:
      cpu: 50m
      memory: 100Mi

repoServer:
  resources:
    requests:
      cpu: 300m
      memory: 400Mi
    limits:
      cpu: 500m
      memory: 600Mi

server:
  ingress:
    enabled: true
    ingressClassName: nginx
    hostname: argocd.drkube.local
    annotations:
      cert-manager.io/cluster-issuer: letsencrypt-prod
      nginx.ingress.kubernetes.io/ssl-redirect: "false"
    extraHosts:
      - name: argocd-drkube.huik.site
        path: /
    extraTls:
      - secretName: argocd-tls
        hosts:
          - argocd-drkube.huik.site
  resources:
    limits:
      cpu: 200m
      memory: 200Mi
    requests:
      cpu: 85m
      memory: 100Mi

notifications:
  enabled: true
  cm:
    create: true
  notifiers:
    "service.webhook.dr-kube": |
      url: "http://host.docker.internal:8080/webhook/argocd"
      headers:
        - name: Content-Type
          value: application/json
  templates:
    "template.app-sync-failed": |
      webhook:
        dr-kube:
          method: POST
          body: |
            {"id":"argocd-{{.app.metadata.name}}-sync-failed","type":"argocd_sync_failed","namespace":"{{.app.metadata.namespace}}","resource":"{{.app.metadata.name}}","error_message":"Sync failed","logs":["{{.app.status.operationState.message}}"],"timestamp":"{{.app.status.operationState.startedAt}}","values_file":"values/{{.app.metadata.name}}.yaml"}
    "template.app-health-degraded": |
      webhook:
        dr-kube:
          method: POST
          body: |
            {"id":"argocd-{{.app.metadata.name}}-health-degraded","type":"argocd_health_degraded","namespace":"{{.app.metadata.namespace}}","resource":"{{.app.metadata.name}}","error_message":"Health Degraded","logs":["{{.app.status.health.message}}"],"timestamp":"","values_file":"values/{{.app.metadata.name}}.yaml"}
  triggers:
    "trigger.on-sync-failed": '[{"when":"app.status.sync.status == ''OutOfSync'' || app.status?.operationState.phase in [''Error'', ''Failed'']","send":["app-sync-failed"]}]'
    "trigger.on-health-degraded": '[{"when":"app.status.health.status == ''Degraded''","send":["app-health-degraded"]}]'
  resources:
    requests:
      cpu: 50m
      memory: 70Mi
    limits:
      cpu: 100m
      memory: 140Mi
