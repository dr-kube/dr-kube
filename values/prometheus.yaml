# https://artifacthub.io/packages/helm/prometheus-community/prometheus
# ============================================
# Prometheus Server
# ============================================
server:
  enabled: true

  securityContext:
    runAsUser: 0
    runAsNonRoot: false
    runAsGroup: 0
    fsGroup: 0

  service:
    type: ClusterIP
    port: 9090

  persistentVolume:
    enabled: true
    storageClass: "standard"
    accessModes:
      - ReadWriteOnce
    size: 8Gi
    mountPath: /data

  ingress:
    enabled: true
    ingressClassName: nginx
    hosts:
      - prometheus.drkube.local
    paths:
      - /
    tls: [] # HTTP만 사용

# ============================================
# Alertmanager
# ============================================
alertmanager:
  enabled: true

  persistence:
    enabled: true
    storageClass: "standard"
    accessModes:
      - ReadWriteOnce
    size: 2Gi
    mountPath: /data

  ingress:
    enabled: true
    className: nginx
    hosts:
      - host: alert.drkube.local
        paths:
          - path: /
            pathType: Prefix

  # Alertmanager webhook 설정
  config:
    global:
      resolve_timeout: 5m
    route:
      receiver: "slack-notifications"
      group_by: ["alertname", "namespace", "pod"]
      group_wait: 10s
      group_interval: 30s
      repeat_interval: 1h
    receivers:
      - name: slack-notifications
        slack_configs:
          - api_url: "<SLACK_WEBHOOK_URL>"   # 별도 파일에서 관리
            channel: "#alert"
            send_resolved: true
            title: "{{ .CommonAnnotations.summary }}"
            text: "{{ .CommonAnnotations.description }}"

# ============================================
# Node Exporter (DaemonSet)
# ============================================
prometheus-nodeExporter:
  enabled: true

  service:
    type: ClusterIP
    port: 9100

  tolerations: []
  hostNetwork: false
  hostPID: false

  extraArgs: []
  podLabels: {}
  resources: {}

# ============================================
# Pushgateway (Off)
# ============================================
prometheus-pushgateway:
  enabled: false

# ============================================
# Prometheus Configuration
# ============================================
serverFiles:
  prometheus.yml:
    scrape_configs:
      # 기본 Prometheus self-scrape
      - job_name: "prometheus"
        static_configs:
          - targets: ["localhost:9090"]
      # Kube-State-Metrics 스크랩
      - job_name: "kube-state-metrics"
        static_configs:
          - targets:
              - "prometheus-kube-state-metrics.monitoring.svc.cluster.local:8080"

      # Node Exporter 자동 스크랩
      - job_name: "node-exporter"
        kubernetes_sd_configs:
          - role: endpoints

        relabel_configs:
          # 1) node-exporter 서비스만 골라잡기
          #    서비스에 app.kubernetes.io/name=prometheus-node-exporter 라벨이 있다고 가정
          - source_labels:
              [__meta_kubernetes_service_label_app_kubernetes_io_name]
            regex: "prometheus-node-exporter"
            action: keep

          # 2) metrics 포트만 사용 (보통 포트 이름이 metrics 또는 http-metrics)
          - source_labels: [__meta_kubernetes_endpoint_port_name]
            regex: "metrics|http-metrics"
            action: keep

          # 3) node 이름을 라벨로 붙이고 싶으면 (옵션)
          - source_labels: [__meta_kubernetes_pod_node_name]
            target_label: "node"

      # 3. cAdvisor (kubelet) 통해 Pod/컨테이너 메트릭 스크랩
      - job_name: "cadvisor"
        scheme: https
        metrics_path: /metrics/cadvisor

        # 각 Node의 kubelet을 API 서버 proxy로 타고 가는 패턴
        kubernetes_sd_configs:
          - role: node

        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true

        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token

        relabel_configs:
          # 노드 라벨을 Prometheus 라벨로 복사
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)

          # 실제 요청은 apiserver로 보내고,
          # metrics_path로 어느 노드인지 지정 (proxy 사용)
          - target_label: __address__
            replacement: kubernetes.default.svc:443

          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/$1/proxy/metrics/cadvisor
  # ===========================================
  # alert rule 설정
  # ============================================
  alerting_rules.yml:
    groups:
      - name: container-oom.rules
        rules:
          - alert: ContainerOOMKilled
            expr: |
              increase(kube_pod_container_status_restarts_total[5m]) >= 1
              and on (namespace, pod, container)
              max_over_time(kube_pod_container_status_last_terminated_reason{reason="OOMKilled"}[5m]) == 1
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "Container OOMKilled 발생"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }}
                컨테이너 {{ $labels.container }} 가
                최근 5분 내 OOMKilled로 인해 재시작되었습니다.

      - name: container-cpu.rules
        rules:
          - alert: CPUThrottling
            expr: |
              rate(container_cpu_cfs_throttled_periods_total[5m])
              / rate(container_cpu_cfs_periods_total[5m]) > 0.5
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "CPU Throttling 발생"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }}
                컨테이너 {{ $labels.container }} 가
                CPU throttling 비율 50% 이상입니다.

      - name: container-crash.rules
        rules:
          - alert: PodCrashLooping
            expr: |
              increase(kube_pod_container_status_restarts_total[10m]) >= 3
            for: 0m
            labels:
              severity: critical
            annotations:
              summary: "Pod CrashLoopBackOff 발생"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }}
                컨테이너 {{ $labels.container }} 가
                최근 10분 내 3회 이상 재시작되었습니다.
      - name: container-memory.rules
        rules:
          - alert: HighMemoryUsage
            expr: |
              (
                container_memory_working_set_bytes
                / container_spec_memory_limit_bytes
              ) > 0.85
              and on (namespace, pod, container)
              container_spec_memory_limit_bytes > 0
            for: 2m
            labels:
              severity: warning
            annotations:
              summary: "메모리 사용량 임계치 초과"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }}
                컨테이너 {{ $labels.container }} 의
                메모리 사용률이 85%를 초과했습니다.

      - name: pod-ready.rules
        rules:
          - alert: PodNotReady
            expr: |
              kube_pod_status_ready{condition="true"} == 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Pod Ready 상태 아님"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }} 가
                Ready 상태가 아닙니다.

      - name: container-waiting.rules
        rules:
          - alert: ContainerWaiting
            expr: |
              kube_pod_container_status_waiting_reason{reason!="ContainerCreating"} > 0
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "컨테이너 대기 상태 감지"
              description: |
                Pod {{ $labels.namespace }}/{{ $labels.pod }}
                컨테이너 {{ $labels.container }} 가
                대기 상태입니다. (reason={{ $labels.reason }})

      - name: deployment-replicas.rules
        rules:
          - alert: DeploymentReplicasMismatch
            expr: |
              kube_deployment_spec_replicas
              !=
              kube_deployment_status_replicas_available
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "Deployment 레플리카 불일치"
              description: |
                Deployment {{ $labels.namespace }}/{{ $labels.deployment }} 의
                spec_replicas 와 available_replicas 가 일치하지 않습니다.

      - name: node-cpu.rules
        rules:
          - alert: NodeHighCPU
            expr: |
              100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
            annotations:
              summary: "노드 CPU 사용률 높음"
              description: |
                노드 {{ $labels.instance }} 의
                CPU 사용률이 80%를 초과했습니다.

  # alerting_rules.yml:
  #   groups:
  #   - name: container-oom.rules
  #     rules:
  #       - alert: ContainerOOMKilled
  #         expr: kube_pod_container_status_last_terminated_reason{reason="OOMKilled"} == 1
  #         for: 1m
  #         labels:
  #           severity: critical
  #         annotations:
  #           summary: "Container OOMKilled 발생"
  #           description: "Pod {{ $labels.namespace }}/{{ $labels.pod }} 컨테이너 {{ $labels.container }} 가 OOMKilled 되었습니다."
