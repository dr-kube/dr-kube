# https://artifacthub.io/packages/helm/grafana/alloy

alloy:
  configMap:
    create: true
    content: |-
      logging {
        level  = "info"
        format = "logfmt"
      }

      discovery.kubernetes "pods" {
        role = "pod"
        selectors {
          role  = "pod"
          field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
        }
      }

      // 1) Pod 로그 수집
      loki.source.kubernetes "pods" {
        targets    = discovery.kubernetes.pods.targets
        forward_to = [
          loki.write.main.receiver,
          loki.write.drkube.receiver,
        ]
      }

      // 2) 기존 Loki
      loki.write "main" {
        endpoint {
          url = sys.env("LOKI_URL_MAIN")
        }
      }

      // 3) DR-Kube 서버용
      // LOKI_URL_DRKUBE는 환경에 맞게 설정
      loki.write "drkube" {
        endpoint {
          url = sys.env("LOKI_URL_DRKUBE")
        }
      }

  extraEnv:
    - name: LOKI_URL_MAIN
      value: "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"
    - name: LOKI_URL_DRKUBE
      value: "http://133.186.241.170:8080/loki/api/v1/push"
