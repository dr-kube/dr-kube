alloy:
  configMap:
    create: true
    content: |
      // ============================================================
      // 1. Discovery - Kubernetes Pod 자동 탐지
      // ============================================================
      discovery.kubernetes "pods" {
        role = "pod"
      }

      // ============================================================
      // 2. Relabel - 메타 라벨을 실제 라벨로 변환
      // ============================================================
      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        // 기본 라벨 매핑
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }

        // 커스텀 라벨 매핑 (app, version, env)
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
          action        = "replace"
          regex         = "(.+)"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_label_version"]
          target_label  = "version"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_label_env"]
          target_label  = "env"
        }

        // 시스템 namespace 제외
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex         = "kube-system|kube-public|kube-node-lease|argocd|monitoring|external-secrets"
          action        = "drop"
        }
      }

      // ============================================================
      // 3. Loki - 로그 전송 대상 설정
      // ============================================================
      loki.write "default" {
        endpoint {
          url = "http://loki:3100/loki/api/v1/push"
        }
      }

      // ============================================================
      // 4. Source - Pod 로그 수집
      // ============================================================
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.pod_logs.receiver]
      }

      // ============================================================
      // 5. Process - 로그 처리 파이프라인
      // ============================================================
      loki.process "pod_logs" {
        // --- 5.1 Docker 로그 파싱 ---
        stage.docker {}

        // --- 5.2 JSON 로그 파싱 (구조화된 로그) ---
        stage.json {
          expressions = {
            level      = "level",
            msg        = "msg",
            message    = "message",
            timestamp  = "timestamp",
            time       = "time",
            caller     = "caller",
            error      = "error",
            err        = "err",
            trace_id   = "trace_id",
            span_id    = "span_id",
            request_id = "request_id",
            user_id    = "user_id",
            method     = "method",
            path       = "path",
            status     = "status",
            duration   = "duration",
            latency    = "latency",
          }
        }

        // --- 5.3 Non-JSON 로그 파싱 (일반 텍스트 로그) ---
        // Python/Celery 로그 형식: "2026-01-07 12:00:00.089 INFO [process] message"
        stage.regex {
          expression = "^(?P<timestamp>\\d{4}-\\d{2}-\\d{2}\\s+\\d{2}:\\d{2}:\\d{2}\\.\\d+)\\s+(?P<log_level>\\w+)\\s+\\[.*?\\]\\s+(?P<log_message>.*)"
        }

        // Django 로그 형식도 파싱
        stage.regex {
          expression = "\\[(?P<django_timestamp>.*?)\\]\\s+(?P<django_level>\\w+)\\s+(?P<django_message>.*)"
        }

        // --- 5.4 Level 라벨 추출 및 정규화 ---
        // JSON에서 추출된 level
        stage.labels {
          values = { level = "level" }
        }

        // Non-JSON에서 추출된 level (우선순위: log_level > django_level)
        stage.labels {
          values = { level = "log_level" }
        }
        stage.labels {
          values = { level = "django_level" }
        }

        // 텍스트에서 level 추출 (최종 fallback)
        stage.regex {
          expression = "(?i)(?P<extracted_level>trace|debug|info|warn|warning|error|err|fatal|panic)"
        }
        stage.labels {
          values = { level = "extracted_level" }
        }

        // Level 정규화 (대소문자, 축약형 통일)
        stage.replace {
          expression = "(?i)^(warn)$"
          source     = "level"
          replace    = "warning"
        }
        stage.replace {
          expression = "(?i)^(err)$"
          source     = "level"
          replace    = "error"
        }
        stage.replace {
          expression = "(?i)^(debug|info|warning|error|fatal|panic)$"
          source     = "level"
          replace    = "$1"
        }

        // --- 5.5 시스템 컨테이너 로그 제외 ---
        stage.match {
          selector = "{container=~\"loki|alloy|kube-proxy|aws-node|coredns\"}"
          action   = "drop"
        }

        // --- 5.6 노이즈 로그 필터링 (JSON/Non-JSON 모두 적용) ---

        // HTTP Health Check 및 프로브 요청
        stage.drop {
          expression          = "(?i)(GET|POST|HEAD).*(health|healthz|readiness|liveness|ready|live|ping|favicon)"
          drop_counter_reason = "health_check"
        }
        stage.drop {
          expression          = "(kube-probe|Go-http-client)"
          drop_counter_reason = "kube_probe"
        }
        stage.drop {
          expression          = "(GET|POST).*/metrics"
          drop_counter_reason = "metrics_endpoint"
        }

        // Root path health check (GET / 요청) - 모든 GET / 로그 차단
        stage.drop {
          expression          = "\\bGET\\s+/\\s*$"
          drop_counter_reason = "root_path_health_check"
        }
        stage.drop {
          expression          = "\\bGET\\s+/$"
          drop_counter_reason = "root_path_get_only"
        }

        // 성공 응답 로그 (Returned 200/201/204)
        stage.drop {
          expression          = "(?i)Returned\\s+(200|201|204)\\s+in\\s+\\d+\\s*ms"
          drop_counter_reason = "success_response_log"
        }

        // ALB/ELB health check (특정 User-Agent)
        stage.drop {
          expression          = "(?i)(ELB-HealthChecker|Amazon-Route53-Health-Check-Service)"
          drop_counter_reason = "alb_health_check"
        }

        // Celery 스케줄러 정기 작업 로그 (매우 빈번)
        stage.drop {
          expression          = "(?i)Scheduler: Sending due task"
          drop_counter_reason = "celery_scheduler_routine"
        }

        // Celery Beat 스케줄 확인 및 작성 로그
        stage.drop {
          expression          = "(?i)(celerybeat|beat):.*(Scheduler|Writing entries|waking up)"
          drop_counter_reason = "celery_beat_routine"
        }

        // Database connection pool 상태 로그
        stage.drop {
          expression          = "(?i)(connection pool|pool size|idle connections)"
          drop_counter_reason = "db_pool_routine"
        }

        // 반복적인 연결 상태 확인 로그
        stage.drop {
          expression          = "(?i)(connected to|connection (established|successful|alive)|heartbeat|keepalive)"
          drop_counter_reason = "connection_routine"
        }

        // 정상 종료/시작 로그 (워커 재시작 등)
        stage.drop {
          expression          = "(?i)(worker.*ready|worker.*started|shutting down gracefully)"
          drop_counter_reason = "worker_lifecycle"
        }

        // 빈 줄 또는 공백만 있는 로그
        stage.drop {
          expression          = "^\\s*$"
          drop_counter_reason = "empty_line"
        }

        // Static 파일 요청 (개발 환경에서만 발생)
        stage.drop {
          expression          = "(?i)(GET|POST).*/static/"
          drop_counter_reason = "static_files"
        }

        // Kafka 내부 동작 로그 (매우 빈번)
        stage.drop {
          expression          = "(?i)Sent auto-creation request for Set\\(__consumer_offsets\\)"
          drop_counter_reason = "kafka_auto_creation"
        }
        stage.drop {
          expression          = "(?i)kafka\\.server\\.(DefaultAutoTopicCreationManager|ReplicaManager|GroupCoordinator)"
          drop_counter_reason = "kafka_internal_operations"
        }
        stage.drop {
          expression          = "(?i)(Fetching metadata|Updated partition metadata|Successfully fetched metadata)"
          drop_counter_reason = "kafka_metadata_routine"
        }
        stage.drop {
          expression          = "(?i)(Group coordinator|Rebalance (started|completed)|Syncing group state)"
          drop_counter_reason = "kafka_rebalance_routine"
        }
        stage.drop {
          expression          = "(?i)(Offset commit|Committing offsets|Successfully committed)"
          drop_counter_reason = "kafka_offset_commit_routine"
        }

        // --- 5.8 Rate Limiting (과도한 로그 발생 방지) ---
        stage.limit {
          rate  = 1000
          burst = 2000
        }

        forward_to = [loki.write.default.receiver]
      }

  mounts:
    varlog: true
    dockercontainers: true

  securityContext:
    privileged: true
    runAsUser: 0

  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 256Mi

controller:
  type: daemonset

rbac:
  create: true

serviceAccount:
  create: true
