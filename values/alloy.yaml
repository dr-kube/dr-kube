# values.yaml (grafana/alloy용)

# 컨트롤러 타입: 기본이 daemonset 이라 그대로 둠
controller:
  type: daemonset

image:
  # -- Grafana Alloy image registry (defaults to docker.io)
  registry: "docker.io"
  # -- Grafana Alloy image repository.
  repository: grafana/alloy
  # -- (string) Grafana Alloy image tag. When empty, the Chart's appVersion is
  # used.
  tag: null
  # -- Grafana Alloy image's SHA256 digest (either in format "sha256:XYZ" or "XYZ"). When set, will override `image.tag`.
  digest: null
  # -- Grafana Alloy image pull policy.
  pullPolicy: IfNotPresent
  # -- Optional set of image pull secrets.
  pullSecrets: []


alloy:
  # Alloy 설정을 values.yaml 안에 직접 넣는 방식 (공식 문서 방식)
  # ref: https://grafana.com/docs/alloy/latest/configure/kubernetes/
  configMap:
    create: true
    # name, key는 기본값(alloy-config, config.alloy)을 그대로 사용
    content: |-
      logging {
        level  = "info"
        format = "logfmt"
      }

      // -----------------------------
      // 1. Kubernetes Pod 디스커버리
      // -----------------------------
      discovery.kubernetes "pods" {
        role = "pod"

        // DaemonSet 기준으로, 자기 노드 것만 보게 하는 공식 예제 옵션
        selectors {
          role  = "pod"
          field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
        }
      }

      // -----------------------------
      // 2. Pod 로그 수집 → Loki
      // -----------------------------
      loki.source.kubernetes "pods" {
        targets    = discovery.kubernetes.pods.targets
        forward_to = [loki.write.local.receiver]
      }

      // -----------------------------
      // 3. Loki write
      // -----------------------------
      loki.write "local" {
        endpoint {
          url = sys.env("LOKI_URL")
        }
      }

  # Alloy 컨테이너에 들어갈 환경변수 (공식 values: alloy.extraEnv)
  # ref: values.yaml의 alloy.extraEnv
  extraEnv:
    - name: LOKI_URL
      value: "http://loki-gateway.monitoring.svc.cluster.local/loki/api/v1/push"

  # 필요하면 여기서 podSecurityContext, resources 등 추가 가능
  # podSecurityContext: {}
  # resources: {}

# RBAC, ServiceAccount 등은 기본값 그대로 써도
# discovery.kubernetes + loki.source.kubernetes 동작하도록 이미 설정되어 있음.
# (values.yaml에 rbac.rules / clusterRules 기본 포함)
