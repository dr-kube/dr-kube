# https://artifacthub.io/packages/helm/grafana/alloy

# Grafana Alloy - Kubernetes 로그/메트릭 수집 에이전트
# 상세 설정 문서: docs/ALLOY_CONFIG.md
alloy:
  # Alloy 설정을 values.yaml 안에 직접 넣는 방식 (공식 문서 방식)
  # ref: https://grafana.com/docs/alloy/latest/configure/kubernetes/
  configMap:
    create: true
    # name, key는 기본값(alloy-config, config.alloy)을 그대로 사용
    content: |-
      logging {
        level  = "info"
        format = "logfmt"
      }

      // ============================================================
      // 1. Discovery - Kubernetes Pod 자동 탐지
      // ============================================================
      discovery.kubernetes "pods" {
        role = "pod"

        // DaemonSet 기준: 자기 노드 것만 보게 하는 공식 예제 옵션
        selectors {
          role  = "pod"
          field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
        }
      }

      // ============================================================
      // 2. Relabel - 메타 라벨을 실제 라벨로 변환
      // ============================================================
      discovery.relabel "pods" {
        targets = discovery.kubernetes.pods.targets

        // 기본 라벨 매핑
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          target_label  = "namespace"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_name"]
          target_label  = "pod"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_container_name"]
          target_label  = "container"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_node_name"]
          target_label  = "node"
        }

        // 커스텀 라벨 매핑 (app만 유지)
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app"]
          target_label  = "app"
        }
        rule {
          source_labels = ["__meta_kubernetes_pod_label_app_kubernetes_io_name"]
          target_label  = "app"
          action        = "replace"
          regex         = "(.+)"
        }
        // version/env 라벨은 제외 (요청사항)

        // 시스템 namespace 제외 (kube-system, kube-public, kube-node-lease만)
        rule {
          source_labels = ["__meta_kubernetes_namespace"]
          regex         = "kube-system|kube-public|kube-node-lease"
          action        = "drop"
        }
      }

      // ============================================================
      // 3. Loki - 로그 전송 대상 설정
      // ============================================================
      loki.write "local" {
        endpoint {
          url = sys.env("LOKI_URL")
        }
      }

      // ============================================================
      // 4. Source - Pod 로그 수집
      // ============================================================
      loki.source.kubernetes "pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [loki.process.pod_logs.receiver]
      }

      // ============================================================
      // 5. Process - 로그 처리 파이프라인
      // ============================================================
      loki.process "pod_logs" {
        // --- 5.1 Docker 로그 파싱 ---
        stage.docker {}

        // --- 5.2 JSON 로그 파싱 (구조화된 로그) ---
        stage.json {
          expressions = {
            // 표준 필드
            level      = "level",
            severity   = "severity",      // frontend 등 severity 사용하는 앱
            msg        = "msg",
            message    = "message",
            timestamp  = "timestamp",
            time       = "time",
            ts         = "ts",            // 일부 앱에서 사용
            caller     = "caller",
            // 에러 정보
            error      = "error",
            err        = "err",
            stack      = "stack",
            stacktrace = "stacktrace",
            // 트레이싱
            trace_id   = "trace_id",
            traceId    = "traceId",       // camelCase 버전
            traceID    = "traceID",
            span_id    = "span_id",
            spanId     = "spanId",
            spanID     = "spanID",
            // HTTP 요청 정보
            request_id = "request_id",
            requestId  = "requestId",
            http_req_id = "http.req.id",  // frontend 스타일
            user_id    = "user_id",
            userId     = "userId",
            method     = "method",
            http_method = "http.req.method",
            path       = "path",
            http_path  = "http.req.path",
            status     = "status",
            http_status = "http.resp.status",
            duration   = "duration",
            latency    = "latency",
            took_ms    = "http.resp.took_ms",
            // 서비스 정보
            service    = "service",
            component  = "component",
          }
        }

        // --- 5.3 Logfmt 파싱 (Grafana 스타일 로그) ---
        stage.logfmt {
          mapping = {
            level   = "level",
            msg     = "msg",
            logger  = "logger",
            caller  = "caller",
            err     = "err",
            method  = "method",
            path    = "path",
            status  = "status",
            t       = "timestamp",
          }
        }

        // --- 5.4 Plain text 로그 파싱 (비구조화 로그) ---
        // 타임스탬프 + 레벨 + 메시지 패턴
        stage.regex {
          expression = "^(?P<timestamp>\\d{4}-\\d{2}-\\d{2}[T\\s]\\d{2}:\\d{2}:\\d{2}[.,]?\\d*)\\s*(?P<log_level>TRACE|DEBUG|INFO|WARN(?:ING)?|ERROR|FATAL|PANIC)?\\s*(?P<log_message>.*)"
        }
        // 대괄호 포맷: [timestamp] LEVEL message
        stage.regex {
          expression = "\\[(?P<bracket_timestamp>[^\\]]+)\\]\\s*(?P<bracket_level>TRACE|DEBUG|INFO|WARN(?:ING)?|ERROR|FATAL|PANIC)?\\s*(?P<bracket_message>.*)"
        }
        // 함수 호출 패턴: FunctionName called with param=value
        stage.regex {
          expression = "^(?P<func_name>[A-Z][a-zA-Z]+)\\s+(called|started|finished|completed)\\s+(?:with\\s+)?(?P<func_params>.*)"
        }

        // --- 5.5 Level 라벨 정규화 (여러 소스에서 통합) ---
        // severity -> level (frontend 등)
        stage.labels {
          values = { level = "severity" }
        }
        // 기타 level 소스들
        stage.labels {
          values = { level = "level" }
        }
        stage.labels {
          values = { level = "log_level" }
        }
        stage.labels {
          values = { level = "bracket_level" }
        }
        // 텍스트에서 추출
        stage.regex {
          expression = "(?i)\\b(?P<extracted_level>trace|debug|info|warn(?:ing)?|error|err|fatal|panic|critical)\\b"
        }
        stage.labels {
          values = { level = "extracted_level" }
        }

        // Level 값 표준화 (소문자, warning/error 통일)
        stage.replace {
          expression = "(?i)^(warn)$"
          source     = "level"
          replace    = "warning"
        }
        stage.replace {
          expression = "(?i)^(err)$"
          source     = "level"
          replace    = "error"
        }
        stage.replace {
          expression = "(?i)^(TRACE|DEBUG|INFO|WARNING|ERROR|FATAL|PANIC|CRITICAL)$"
          source     = "level"
          replace    = "{{ ToLower .Value }}"
        }

        // --- 5.6 Trace ID 정규화 ---
        stage.labels {
          values = { trace_id = "trace_id" }
        }
        stage.labels {
          values = { trace_id = "traceId" }
        }
        stage.labels {
          values = { trace_id = "traceID" }
        }

        // --- 5.7 시스템 컨테이너 로그 제외 ---
        stage.match {
          selector = "{container=~\"loki|alloy|kube-proxy|aws-node|coredns|etcd|kube-scheduler|kube-controller-manager\"}"
          action   = "drop"
        }

        // --- 5.8 DEBUG 레벨 로그 드롭 (가장 중요한 필터!) ---
        stage.match {
          selector = "{level=\"debug\"}"
          action   = "drop"
        }

        // --- 5.9 노이즈 로그 필터링 (강화됨) ---
        // Health check 관련
        stage.drop {
          expression          = "(?i)(GET|POST|HEAD).*(health|healthz|readiness|liveness|ready|live|ping|favicon)"
          drop_counter_reason = "health_check"
        }
        stage.drop {
          expression          = "(kube-probe|Go-http-client|x-readiness-probe|x-liveness-probe)"
          drop_counter_reason = "kube_probe"
        }
        stage.drop {
          expression          = "(?i)(ELB-HealthChecker|Amazon-Route53-Health-Check-Service|GoogleHC)"
          drop_counter_reason = "cloud_health_check"
        }
        stage.drop {
          expression          = "(?i)session.*x-(readiness|liveness)-probe"
          drop_counter_reason = "probe_session"
        }

        // Metrics/pprof 엔드포인트
        stage.drop {
          expression          = "(GET|POST).*/metrics"
          drop_counter_reason = "metrics_endpoint"
        }
        stage.drop {
          expression          = "(GET|POST).*/debug/pprof"
          drop_counter_reason = "pprof_endpoint"
        }

        // 정적 파일 요청
        stage.drop {
          expression          = "(?i)(GET|POST).*/static/"
          drop_counter_reason = "static_files"
        }
        stage.drop {
          expression          = "(?i)(GET|POST).*\\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)($|\\?)"
          drop_counter_reason = "static_assets"
        }

        // 성공 응답 로그 (노이즈)
        stage.drop {
          expression          = "(?i)Returned\\s+(200|201|204)\\s+in\\s+\\d+\\s*ms"
          drop_counter_reason = "success_response"
        }
        stage.drop {
          expression          = "\"status\":\\s*(200|201|204)"
          drop_counter_reason = "json_success_status"
        }

        // 반복적인 루틴 로그
        stage.drop {
          expression          = "(?i)(worker.*ready|worker.*started|shutting down gracefully)"
          drop_counter_reason = "worker_lifecycle"
        }
        stage.drop {
          expression          = "(?i)(connection pool|pool size|idle connections)"
          drop_counter_reason = "db_pool_routine"
        }
        stage.drop {
          expression          = "(?i)(connected to|connection (established|successful|alive)|heartbeat|keepalive)"
          drop_counter_reason = "connection_routine"
        }
        stage.drop {
          expression          = "(?i)Scheduler: Sending due task"
          drop_counter_reason = "celery_scheduler"
        }
        stage.drop {
          expression          = "(?i)(celerybeat|beat):.*(Scheduler|Writing entries|waking up)"
          drop_counter_reason = "celery_beat"
        }

        // Kafka 내부 로그
        stage.drop {
          expression          = "(?i)Sent auto-creation request for Set\\(__consumer_offsets\\)"
          drop_counter_reason = "kafka_auto_creation"
        }
        stage.drop {
          expression          = "(?i)kafka\\.server\\.(DefaultAutoTopicCreationManager|ReplicaManager|GroupCoordinator)"
          drop_counter_reason = "kafka_internal"
        }
        stage.drop {
          expression          = "(?i)(Fetching metadata|Updated partition metadata|Successfully fetched metadata)"
          drop_counter_reason = "kafka_metadata"
        }
        stage.drop {
          expression          = "(?i)(Group coordinator|Rebalance (started|completed)|Syncing group state)"
          drop_counter_reason = "kafka_rebalance"
        }
        stage.drop {
          expression          = "(?i)(Offset commit|Committing offsets|Successfully committed)"
          drop_counter_reason = "kafka_offset"
        }

        // Grafana 내부 로그
        stage.drop {
          expression          = "logger=context.*Request Completed.*status=200"
          drop_counter_reason = "grafana_success_request"
        }
        stage.drop {
          expression          = "logger=tsdb\\.loki.*Response (received|parsed)"
          drop_counter_reason = "grafana_loki_query"
        }

        // 빈 줄/공백
        stage.drop {
          expression          = "^\\s*$"
          drop_counter_reason = "empty_line"
        }

        // gRPC 반복 로그 (online-boutique)
        stage.drop {
          expression          = "(?i)GetCartAsync called with userId"
          drop_counter_reason = "cart_service_routine"
        }
        stage.drop {
          expression          = "(?i)(GetSupportedCurrencies|GetQuote|ShipOrder) (called|completed)"
          drop_counter_reason = "boutique_routine_calls"
        }

        // --- 5.10 Rate Limiting (과도한 로그 발생 방지) ---
        stage.limit {
          rate  = 500     // 초당 500개로 감소 (기존 1000)
          burst = 1000    // 버스트도 감소 (기존 2000)
        }

        forward_to = [loki.write.local.receiver]
      }

      // ============================================================
      // 6. Pyroscope - Continuous Profiling
      // ============================================================
      
      // Pyroscope 서버로 프로파일 전송
      pyroscope.write "default" {
        endpoint {
          url = "http://pyroscope.monitoring:4040"
        }
      }

      // Kubernetes pods에서 프로파일 수집 (pprof 엔드포인트가 있는 앱)
      pyroscope.scrape "kubernetes_pods" {
        targets    = discovery.relabel.pods.output
        forward_to = [pyroscope.write.default.receiver]

        profiling_config {
          profile.process_cpu {
            enabled = true
          }
          profile.memory {
            enabled = true
          }
          profile.goroutine {
            enabled = true
          }
        }

        clustering {
          enabled = true
        }
      }

      // eBPF 프로파일링 - 모든 언어 앱 지원 (Go, Java, Python, Node.js 등)
      pyroscope.ebpf "instance" {
        forward_to = [pyroscope.write.default.receiver]

        targets = discovery.relabel.pods.output
      }

  # Alloy 컨테이너에 들어갈 환경변수 (공식 values: alloy.extraEnv)
  # ref: values.yaml의 alloy.extraEnv
  extraEnv:
    - name: LOKI_URL
      value: "http://loki:3100/loki/api/v1/push"

  # eBPF 프로파일링을 위한 privileged 권한
  securityContext:
    privileged: true
    runAsUser: 0

# 참고: docs/ALLOY_CONFIG.md 참조
