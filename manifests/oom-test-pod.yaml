apiVersion: v1
kind: Pod
metadata:
  name: oom-test
  labels:
    app: dr-kube-test
    scenario: oom-killed # Agent가 식별할 레이블
spec:
  restartPolicy: Never # 파드가 죽으면 그대로 남아 분석 가능
  containers:
    - name: python-oom
      image: python:3.11-slim
      command:
        - python
        - -c
        - |
          import time
          # 1MB씩 계속 메모리 증가
          data = []
          try:
              while True:
                  # 메모리를 증가시키기 전에 잠깐 기다려, Prometheus가 메트릭을 수집할 시간을 줍니다.
                  time.sleep(0.1) 
                  data.append("X" * 1024 * 1024) 
                  print(f"Memory allocated: {len(data)} MiB")
          except Exception as e:
              # OOMKilled 발생 시 이 블록은 실행되지 않지만, 다른 예외 방지용
              print(f"Error during allocation: {e}")
      resources:
        requests:
          memory: "16Mi"
          cpu: "50m"
        limits:
          memory: "32Mi" # Kubelet이 이 지점에서 OOMKilled 발생시킴
          cpu: "100m"
