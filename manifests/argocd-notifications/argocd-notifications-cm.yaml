# ConfigMap for Argo CD Notifications - separate manifest so data keys (trigger.on-*) are not parsed as nested by Helm
apiVersion: v1
kind: ConfigMap
metadata:
  name: argocd-notifications-cm
  namespace: argocd
data:
  context: |
    argocdUrl: https://argocd.drkube.local
  "service.webhook.dr-kube": |
    url: "http://host.docker.internal:8080/webhook/argocd"
    headers:
    - name: Content-Type
      value: application/json
  "template.app-sync-failed": |
    webhook:
      dr-kube:
        method: POST
        body: |
          {"id":"argocd-{{.app.metadata.name}}-sync-failed","type":"argocd_sync_failed","namespace":"{{.app.metadata.namespace}}","resource":"{{.app.metadata.name}}","error_message":"Sync failed","logs":["{{.app.status.operationState.message}}"],"timestamp":"{{.app.status.operationState.startedAt}}","values_file":"values/{{.app.metadata.name}}.yaml"}
  "template.app-health-degraded": |
    webhook:
      dr-kube:
        method: POST
        body: |
          {"id":"argocd-{{.app.metadata.name}}-health-degraded","type":"argocd_health_degraded","namespace":"{{.app.metadata.namespace}}","resource":"{{.app.metadata.name}}","error_message":"Health Degraded","logs":["{{.app.status.health.message}}"],"timestamp":"","values_file":"values/{{.app.metadata.name}}.yaml"}
  "trigger.on-sync-failed": |
    - when: app.status.sync.status == 'OutOfSync' || app.status?.operationState.phase in ['Error', 'Failed']
      send: [app-sync-failed]
  "trigger.on-health-degraded": |
    - when: app.status.health.status == 'Degraded'
      send: [app-health-degraded]
