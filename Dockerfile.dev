FROM python:3.11-slim

# 작업 디렉토리 설정
WORKDIR /workspace

# 시스템 패키지 업데이트 및 필수 도구 설치
RUN apt-get update && apt-get install -y \
    git \
    curl \
    vim \
    jq \
    && rm -rf /var/lib/apt/lists/*

# kubectl 설치 (최신 stable 버전)
RUN curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
    && chmod +x kubectl \
    && mv kubectl /usr/local/bin/

# ArgoCD CLI 설치 (최신 버전)
RUN curl -sSL -o /usr/local/bin/argocd https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64 \
    && chmod +x /usr/local/bin/argocd

# Helm 설치 (최신 버전)
RUN curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash

# GitHub CLI 설치 (PR 생성용)
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && chmod go+r /usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | tee /etc/apt/sources.list.d/github-cli.list > /dev/null \
    && apt-get update \
    && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# Python 의존성 설치 (agent 디렉토리)
COPY agent/src/requirements.txt /tmp/requirements.txt
RUN pip install --no-cache-dir -r /tmp/requirements.txt

# pytest 추가 설치 (테스트용)
RUN pip install --no-cache-dir pytest pytest-cov

# Git 설정 (기본값)
RUN git config --global user.name "DR-Kube Agent" \
    && git config --global user.email "agent@dr-kube.local"

# 작업 디렉토리로 복귀
WORKDIR /workspace

# 컨테이너 실행 시 기본 명령어 (오버라이드 가능)
CMD ["bash"]
